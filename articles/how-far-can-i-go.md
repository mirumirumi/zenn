---
title: "「引っ越しするけど会社から歩いて10分圏内ってどこまで？」を調べるサービスをつくりました"
emoji: "🚚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [vue, gcp, 個人開発]
published: false
---

こうです。

![](https://mirumi.me/wp-content/uploads/how-far-map.gif)

新しい住居を探そうとしたとき、「会社から歩いてちょうど 30 分のところに住めたら QOL 高くない？」と思いました。(運動できる、公共交通機関と無縁、買い物もできるetc...)

でも **ある一点を中心とした移動可能エリアを知りたいとき、円でざっくりと表示をする以外のアプローチがほぼない** ことに気がつきました。海外サイトも含めかなり調べてみましたが、類似のサービスは見当たりません。

という経緯でつくったのが [How far can I go?](https://mirumi.me/apps/how-far-map) というサイト。

https://mirumi.me/apps/how-far-map

https://github.com/mirumirumi/walking-distance-map

ぽちぽちやっていただければわかりますが、結果の精度はかなりのものと思われます。特に道の有無や川沿いなどを検証してもらえるとその効果がすぐにわかるかと。

転職先が決まっているなら、そこにピンを差して交通手段と所要時間を設定してください。HOME'S などの住宅検索サービスには条件絞り込みをしたあとにそれらを地図上にまとめてマッピングできる機能があるので、それらと組み合わせると色々捗るというわけでございます。

![](/images/homes.png)

ぜひブックマークしていただいて、新たな生活を検討する おとも にどうぞ…！

以下技術要素および所感などをまとめています。

## Vue 3 の新機能をフル活用した

Vue 3 の目覚ましい新機能の数々をほとんど使いました。具体的には [Vue 3 公式ガイド](https://v3.ja.vuejs.org/guide/migration/introduction.html#注目すべき新機能)にある項目です：

![](/images/vue-3-new-feature.png)

新機能全体についてわかりやすく読みやすい記事をお探しの場合、つい少し前に投稿された [ゆきさんの記事](https://ics.media/entry/220120/) が素敵です。

### Composition API

もうみなさんもこの字面に飽き飽きしているころかもしれませんが、使ってみたらめちゃ強力でした。本当にすごい改善だと思います。

僕らが享受できるメリットを超簡潔にまとめるなら **どんなにコードを書いても迷子にならない** というところでしょう。

Vue 3 が出始めのころ、よくこんな図を目にしたと思います。

![](/images/options-api.png)
*※画面を縦に占有するのを防ぐためオリジナル画像を加工しています*

関心の分離として色分けされていることはわかったものの、「なぜ Options API(Vue 2 までの基本構文) だとダメで Composition API を使うとよくなるのか」はピンと来ていませんでした。

でも Composition API で書き始めると瞬時にわかります。Vue を書いているときに感じていたなんとなくのストレスの正体が実はほぼここにあったことに。

これまでは、Vue インスタンスと呼ばれるものの中で目的ごとにかなりグルーピングされた記述が求められていました。こんな具合です：

```js
export default {
  components: { RepositoriesFilters, RepositoriesSortBy, RepositoriesList },
  props: {
    user: {
      type: String,
      required: true
    }
  },
  data () {
    return {
      repositories: [],
      filters: { ... },
      searchQuery: ''
    }
  },
  computed: {
    filteredRepositories () { ... },
    repositoriesMatchingSearchQuery () { ... },
  },
  watch: {
    user: 'getUserRepositories'
  },
  methods: {
    getUserRepositories () {
      ...
    },
    updateFilters () { ... },
  },
  mounted () {
    this.getUserRepositories()
  }
}
```

これはつまり「コンピュータの都合にあわせてプログラムの挙動ごとに分類している」状況であり、僕らが本当に望んでいるはずの「アプリケーションのビジネスロジックごとの分類」ではありませんでした。

上記の記述が縦に伸びたら何が起こるか想像できるでしょうか？

--- import するために一番上に行って、components の定義は一番下にまとめてたな。data を定義しないといけないからこれはまた一番上だ、あれ、computed ってどこに書いたっけ？どの template に紐付けたやつだろう…。この watch なに？ ---

移動が面倒なのはもとより、わりとすぐにそのコンポーネントへの記述が心理的に嫌になってきます。メンテナンス性も著しく下がっていくのは言うまでもありません。

Composition API はこの課題を解決するために考えられました。

`setup()` という関数にこれまでの記述をすべて内包させることで、コンポーネント内でのグルーピングをすべて開発者に委ねます。関数を値として利用できる JavaScript の特性を活かしたよいインターフェースなんですよね。

```js
export default {
  setup() {      
    const isLoggedIn = ref(false)
    const onClick = (() => {
      ...
    })
    const styleBind = computed(() => {
      ...
    })
    return { 
      isLoggedIn,
      onClick,
      styleBind,
    }
  }
}
```

新しくコンポーネントを作るたびに各プロパティセットを記述したりなど苦労していた部分がほとんど省かれ、純粋な JavaScript にかなり近づきました。

:::message
ちなみに Composition API によって論理的な関心の分離を行ったあとは、ベタですがブレークポイントなどを使ってマーカージャンプできるようにしておくととても便利です。
:::

でもこれだとまだ弱い。

`setup()` 以外にも `components()` や`props()` などなんとかしたい記述が残っているし、プロパティの型定義は独自表記でなんだか気持ち悪いし、そもそもテンプレートに返す値をわざわざ return で再度明示…？　など疑問が残ります。

そこで次に書く setup 記法によって Vue 3 は最強になるのです（というか今ではこれがないと改良としてはだいぶ弱く感じてしまうほどです）。

### `<script setup>` 記法（Syntax Sugar）

この記法は先ほどの `setup()` 関数の糖衣構文なのですが、**使わない理由が見当たらないほど最高** なのでぜひみなさん使ってください。公式でも利用が推奨されています。

純粋な `setup()` 関数が持っていたと思われる問題は以下です：

- なぜか宣言した各種値を return で返さないといけない（明示のメリットの小ささに対してという意）
    - 変数を返すだけの return が一番下にあることにより、せっかく関心の分離をしたのに毎回上下に移動しないといけない状況が改善されていない
    - この return は縦に伸びていくだけで開発者は中身を意識することがなくなっていき、無駄を感じ始める
- `components()` の定義って本当に二重に必要？
- `props()` の中の型定義はもうちょっと TypeScript ネイティブにしてもらえない？

これらを解決するのが `<script setup>` 記法なのです。

…と、ちょっと長くなりかけているのであとは [こちらの記事](https://zenn.dev/azukiazusa/articles/676d88675e4e74) に全面的に助けていただくことにしましょう！

あと地味に嬉しい点として、**`<script setup>` 内の階層が常にトップレベルになる** というものがあります。

`setup()` は関数なので当然スコープとしては一段階内側になってしまいます。しかし setup 記法では常にグローバルスコープな雰囲気。最も多くコードを書くこの領域がエディタのインデントとして一番左にあることの嬉しさはわざわざ僕が説明するまでもないでしょう。

### Suspense

コンポーネント自体が非同期であった場合、コンポーネントレベルで処理分岐できるようになるものです。たぶん下記を見れば一発でわかります：

```html
<template>
  <suspense>
    <template #default>
      <!-- Your main component! -->
    </template>
    <template #fallback>
      <!-- Component for loading -->
    <template>
  </suspense>
</template>
```

これはつまり **子コンポーネント側でトップレベル await を使える** ということを意味しており、前述の setup 記法と組み合わせると本当に便利になります。

公式からは「まだ仕様が安定していないので本番使用は控えてください」とアナウンス[されていますが](https://v3.ja.vuejs.org/guide/migration/suspense.html)、耐えきれず使ってしまいました。今後の動向を気にしておきます。

### Teleport

モーダルなど明らかにコンポーネントの場所に依存しないけど各コンポーネント内から制御したい…というものがたしかに存在しました。

これをラクに解決してくれるのが Teleport です。

```html
<teleport to="body">
  <ModalBack v-if="isOpenModal" />
</teleport>
```

「こういう単目的のための機能追加ってどうなの？」という向きもあると思うのですが、フロントエンド開発に確実に存在するニーズだと思いますし、それをうまく Vue の仕組みに乗せて解決するこのアイデアは純粋に好きになれました。ストアの使用量も減るし積極的に使っています。

### CSS 変数

「Vue はせっかく同じファイル内に CSS も書いているんだから CSS の記述内部でも JS みたいな世界観が引き継ぎればいいのにな」とずっと思っていたのですが、その第一歩のような機能でした。

`setup()` から任意の値を返して、

```html
<script setup lang="ts">
const color = ref("#ff0000")
</script>
```

それを `<style>` タグ内でバインドします：

```css
.blocks {
  width: 300px;
  height: 200px;
  background-color: v-bind(color);
  ...
}
```

あまり多用すると混乱を招きますし、使わざるを得ない状況になっているならおそらくもっとよい設計がある兆候でもあると思うのですが、ピンポイントで使っていきたい素敵な機能です。

### 状態管理

純粋な Vue 3 内の機能ではないんですが、使わなかった目玉機能の１つに状態管理ライブラリ [Pinia](https://github.com/vuejs/pinia) があります。

![](/images/pinia.png)

これまで使われていた [Vuex](https://vuex.vuejs.org/ja/) では型サポートを加えるのに一手間面倒があり、なおかつストアをモジュール分割しようとするとこの手間が倍増しました。実際僕も面倒ですべて index.ts につくってしまったアプリもあります。

今回はストアの規模も極小だったので見送ったのですが、ほぼ Composition API の感覚で書けるという噂なので次は絶対に使おうと思っています。楽しみ。

## 使用した API リソースなど

使用した API についてです。

### TravleTime

「あのエリア表示どうやってんの？」とずーっと気になっていたと思います。

Google Maps API を使いあるポイントから一定距離離れた地点とのルート検索をし、所要時間が入力された時刻にヒットするまでそれを繰り返す→それを 360° ぐるっと回るまでひたすら API を叩き続けてポイントを集め続ける　**……わけではなく、** このニーズのために開発されたであろうズバリな海外サービスを見つけたのでそれを使いました。

https://traveltime.com/

ただ１つ決定的な問題があって、死ぬほど高いんですよね。

なんと **40万円払いましたｗｗ**

![](/images/pricing.png)
*下に小さく「年払いしかないよ！」と邪悪なことが書いてある。*

まあこうなってしまったのは完全に僕がおバカなだけで、ほぼ完成してから「あれ、これフリープランじゃ無理じゃね？🤔」となっただけです（10 req/min がキツい）。作るのは２週間もかかっていないくらいなのですが、せっかく作ったしもう払っちゃおう！くらいのノリでした。

実際のところ本当に便利で実用的なものを作れたと思っていますし、類似サービスも（少なくとも一般の人は）見つけられないと考えると価値は十分にあるのかなーと。

払ったからには宣伝も積極的にしていきたいです。僕を哀れに思ってくださる方はぜひご友人などにもシェアしてください…。笑

使ってくれる人が増えたら PWA もやってみるとか、あとは Cordova でビルドしてみるのも面白そうかなーなど思ってます。

### Geocoding

ジオコーディング（住所や地名などから座標に変換する作業のこと）には Google Maps API を使いました。AWS にも類似のサービスがあるのですが、データの有用性においてさすがに Google 側の圧勝と言わざるを得なかったです。

![](https://mirumi.me/wp-content/uploads/how-far-map-geocoding.gif)

住所表記というのは凄まじい表記ゆれ幅を考慮しなければならず、なおかつ言語が違うとその特性もまるで変わります。[Amazon Location Service](https://aws.amazon.com/jp/location/) でそれをチューニングするのは至難の業と思えたのでだいぶ助かりました。

今回は取得結果の表示にも一工夫入れてみました。ユーザビリティはどうだったでしょうか…！

## その他もろもろ

そのほか小さいことです。

### ダークモード

ダークモードを実装しました。

![](/images/dark-mode.gif)

Google Maps API で地図を読み込むとき、スタイルセットを設定できるんですよね。

```js
new google.maps.Map(document.getElementById("map") as HTMLElement, {
  center: center,
  zoom:   15,
  styles: shouldDarkMode() ? darkStyle : null,
})
```

しめしめと思って「dark style」的な感じで漁ってみたらあっさり見つかったので対応させました。あとは自分で置いた各パーツ類も一緒に変更させるだけです。

### シークレット管理

「アプリケーション全体のリポジトリを公開しているのに API キーとかどうやって管理しているの？」という質問を以前同僚にされたことがあるので書きます。

やることは

- gpg を使う
- 公開鍵暗号方式ではなく対称鍵暗号方式のみを使う（要はパスワードでの開け閉め）
- 忘れてもいい最強のパスフレーズを GitHub の Repository secrets に登録しておく
- GitHub Actions でそれを参照して復号化させる

です。

「パスフレーズだけでセキュリティ担保できるの？」とか「その運用って継続性あるの？」とかはここでは割愛させていただきます。詳しくは別に記事を書いてあるのでご興味ある方はぜひどうぞ。

https://mirumi.me/tech/231

## おわりに

まあとにかく **Vue 3（と setup 記法）がよすぎる** ということに尽きます！！

機能追加や修正が楽しくてどんどん書けちゃうし、いくら書いてもメンテナンス性が全く落ちないことに心底感動します。１回 Vue から離れた過去がある人にはなおさら触ってほしいです。

型についても同じです。「"TypeScriptと相性が悪い" というのは過去のものになった」とみなさんも色んなところで見かけるようになったと思いますが本当にそうだし、「コードを書く」という作業自体の体験もバリバリ向上しています（エディタ上のサポートなど）。

自分の仕事は AWS 系なので会社でフロントエンドを書いている人などまわりには一人もおらず、共感してもらえる相手がいなくていつも寂しい思いをしています…。この記事を読んでくれた方が少しでも Vue に興味を持ってくれたら嬉しいです！

お読みくださりありがとうございました。
お引っ越しの際にはぜひご利用ください～

https://mirumi.me/apps/how-far-map
